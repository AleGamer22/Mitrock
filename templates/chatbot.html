<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitrock IA</title>
    <style>
        :root{
            --bg-1: #0f1720;
            --bg-2: #0b1220;
            --panel: rgba(255,255,255,0.03);
            --accent: #4fb0ff;
            --accent-2: #7b61ff;
            --muted: #9aa4b2;
            --muted-strong: #e6eef9;
            --glass-blur: 10px;
            --radius: 12px;
        }

        /* Reset + full viewport */
        html,body{
            height:100%;
            margin:0;
            font-family: "Segoe UI", Roboto, Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            background:
                radial-gradient(1200px 600px at 10% 20%, rgba(123,97,255,0.06), transparent 8%),
                radial-gradient(900px 500px at 90% 80%, rgba(79,176,255,0.04), transparent 10%),
                linear-gradient(180deg,var(--bg-1), var(--bg-2));
            color:var(--muted);
            box-sizing:border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* App shell stretches full screen */
        #chat-container{
            position:fixed;
            inset:0;
            display:grid;
            grid-template-rows: 72px 1fr auto;
            gap:0;
            max-width:1400px;
            margin:0 auto;
            width:100%;
            height:100vh;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius: 0;
            border-left: 1px solid rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.02);
            box-shadow: 0 30px 80px rgba(2,6,23,0.6);
            overflow:hidden;
            backdrop-filter: blur(var(--glass-blur));
        }

        /* Header (ChatGPT-like) */
        #chat-header{
            display:flex;
            align-items:center;
            gap:16px;
            padding:14px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
        }
        #brand {
            display:flex;
            gap:12px;
            align-items:center;
        }
        #brand .logo {
            width:40px; height:40px; border-radius:8px;
            background: linear-gradient(135deg,var(--accent),var(--accent-2));
            display:inline-flex;
            align-items:center;
            justify-content:center;
            color:#031022;
            font-weight:700;
            box-shadow: 0 8px 24px rgba(123,97,255,0.12);
        }
        #chat-header h1{ margin:0; font-size:1.05rem; color:var(--muted-strong); letter-spacing:0.2px; }
        #chat-header .subtitle { color:var(--muted); font-size:0.85rem; margin-left:auto; }

        /* Chat log */
        #chat-log{
            padding:28px;
            overflow:auto;
            display:flex;
            flex-direction:column;
            gap:18px;
            align-items:stretch;
            scrollbar-width:thin;
            scrollbar-color: rgba(255,255,255,0.08) transparent;
            -webkit-overflow-scrolling: touch;
            background:
                linear-gradient(180deg, rgba(255,255,255,0.0005), rgba(255,255,255,0.0002));
        }
        #chat-log::-webkit-scrollbar{ width:10px; height:10px; }
        #chat-log::-webkit-scrollbar-thumb{
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border-radius:20px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        /* Message container and animation */
        .message-container{
            display:flex;
            gap:12px;
            max-width:78%;
            align-items:flex-end;
            animation: msg-entrance 320ms cubic-bezier(.2,.9,.3,1);
            position:relative;
            word-wrap:break-word;
        }
        @keyframes msg-entrance{
            from { opacity:0; transform: translateY(8px) scale(.995); }
            to   { opacity:1; transform: translateY(0) scale(1); }
        }

        /* Left = bot, Right = user */
        .bot-message{
            margin-right:auto;
            background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));
            color: var(--muted-strong);
            padding:14px 16px;
            border-radius:14px 14px 14px 6px;
            box-shadow: 0 6px 18px rgba(12,18,30,0.35);
            font-size:0.98rem;
            line-height:1.5;
            position:relative;
        }
        .user-message{
            margin-left:auto;
            background: linear-gradient(180deg, rgba(79,176,255,0.16), rgba(123,97,255,0.12));
            color: #041224;
            padding:14px 16px;
            border-radius:14px 14px 6px 14px;
            box-shadow: 0 6px 18px rgba(11,20,30,0.45);
            font-size:0.98rem;
            line-height:1.5;
        }
        .error-message{
            margin-left:auto;
            margin-right:auto;
            background: rgba(255,107,107,0.08);
            color: #ff9a9a;
            padding:10px 14px;
            border-radius:10px;
            font-size:0.92rem;
            text-align:center;
        }

        /* Typing indicator - hidden by default, shown when .active */
        .bot-message.typing{ display:none; align-items:center; gap:8px; }
        .bot-message.typing.active{ display:inline-flex; background:transparent; box-shadow:none; color:var(--muted); padding:8px 12px; }
        .bot-message.typing span{
            display:inline-block;
            width:9px; height:9px;
            margin-right:6px;
            background: linear-gradient(180deg, #d1d5db, #9aa4b2);
            border-radius:50%;
            transform:scale(.2);
            animation: typing-bounce 1.2s infinite ease-in-out;
        }
        .bot-message.typing span:nth-child(2){ animation-delay:0.15s; }
        .bot-message.typing span:nth-child(3){ animation-delay:0.30s; }
        @keyframes typing-bounce{
            0%{ transform:translateY(0) scale(.6); opacity:.35;}
            50%{ transform:translateY(-6px) scale(1); opacity:1;}
            100%{ transform:translateY(0) scale(.6); opacity:.35;}
        }

        /* Input area fixed look (grid bottom row) */
        #input-area{
            padding:14px;
            display:flex;
            gap:12px;
            align-items:center;
            border-top: 1px solid rgba(255,255,255,0.02);
            background: linear-gradient(0deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
        }
        #user-input{
            flex:1;
            padding:14px 16px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 12px;
            color: var(--muted-strong);
            outline:none;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.01);
            transition: box-shadow .18s ease, transform .08s ease;
            font-size:1rem;
        }
        #user-input:focus{
            box-shadow: 0 8px 30px rgba(79,176,255,0.08), inset 0 1px 0 rgba(255,255,255,0.02);
            transform: translateY(-1px);
        }
        #user-input::placeholder{ color: rgba(230,238,249,0.35); }

        /* Buttons */
        .btn-send{
            background: linear-gradient(180deg,var(--accent), var(--accent-2));
            color:#041224;
            border:none;
            padding:10px 14px;
            border-radius:10px;
            cursor:pointer;
            font-weight:600;
            letter-spacing:0.2px;
            transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
            box-shadow: 0 8px 24px rgba(123,97,255,0.12);
        }
        .btn-send:hover{ transform: translateY(-3px); opacity:0.98; box-shadow: 0 18px 42px rgba(123,97,255,0.16); }
        .btn-send:active{ transform: translateY(-1px); }

        #chat-buttons{ display:flex; gap:12px; padding:12px 20px; justify-content:flex-end; border-top: 1px solid rgba(255,255,255,0.02); background:transparent; }
        #chat-buttons .btn-secondary{ background: rgba(255,255,255,0.02); color:var(--muted); padding:8px 12px; border-radius:10px; box-shadow:none; cursor:pointer; }
        #chat-buttons .btn-secondary:hover{ background: rgba(255,255,255,0.03); color: var(--muted-strong); }

        /* Watermark */
        #watermark{ position:absolute; bottom:18px; right:18px; opacity:0.9; filter: drop-shadow(0 8px 20px rgba(0,0,0,0.6)); }
        #watermark img{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:3px solid rgba(255,255,255,0.03); }

        /* Responsive adjustments - prefer desktop but adapt to mobile */
        @media (max-width:900px){
            #chat-container{ grid-template-rows: 64px 1fr auto; }
            #chat-log{ padding:18px; gap:14px; }
            .message-container{ max-width:86%; }
            #chat-header h1{ font-size:1rem; }
        }
        @media (max-width:520px){
            #chat-container{ padding-bottom:0; }
            #chat-header{ padding:12px 14px; }
            #brand .logo{ width:36px; height:36px; }
            #user-input{ padding:12px; font-size:0.96rem; }
            .message-container{ max-width:92%; }
            #chat-buttons{ padding:8px 12px; justify-content:space-between; }
            #watermark{ display:none; }
        }

    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">
            <div id="brand">
                <div class="logo">M</div>
                <div>
                    <h1>Mitrock IA</h1>
                    <div class="subtitle">Asistente inteligente</div>
                </div>
            </div>
            <div class="subtitle">Preferencia PC · Responsive</div>
        </div>

        <div id="chat-log" role="log" aria-live="polite">
            <div class="message-container">
                <div class="bot-message">Envia un mensaje para empezar!</div>
            </div>
            <div id="typing-indicator" class="bot-message typing" aria-hidden="true">
                <span></span><span></span><span></span>
            </div>
        </div>

        <div id="input-area" role="region" aria-label="Entrada de mensaje">
            <input type="text" id="user-input" placeholder="Escribe tu mensaje y presiona Enter..." autocomplete="off" />
            <button type="button" class="btn-send" onclick="sendMessage()">Enviar</button>
        </div>

        <div id="chat-buttons">
            <button class="btn-secondary" onclick="resetChat()">Reiniciar IA</button>
            <button class="btn-secondary" onclick="regenerateResponse()">Regenerar Respuesta</button>
        </div>

        <div id="watermark">
            <a href="https://www.youtube.com/@AleNationVibes" target="_blank" rel="noopener noreferrer">
                <img src="https://yt3.googleusercontent.com/6dHA4A14WdEOq_yGMebxHmgUtin9WVNNOEqYPU_QqZh_1hGatrZVeia24m6qpoyMz7aNwsSRhA=s160-c-k-c0x00ffffff-no-rj" alt="Logo Mitrock IA">
            </a>
        </div>
    </div>

    <script>
        const userInput = document.getElementById("user-input");
        const chatLog = document.getElementById("chat-log");
        let typingIndicator = document.getElementById("typing-indicator");

        // Helper: sanitize minimal HTML -> keep selected formatting tags, remove scripts/attrs
        function stripTags(html){
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
        }

        function sanitizeHTML(html){
            const template = document.createElement('template');
            template.innerHTML = html;

            const allowedTags = new Set(['strong','b','em','i','u','code','pre','a','br','p','ul','ol','li','span']);
            const allowedAttrs = { a: ['href', 'target', 'rel'] };
            const isSafeUrl = (url) => /^(https?:|mailto:|\/)/i.test(url);

            function clean(node){
                if (node.nodeType === Node.TEXT_NODE) return;
                if (node.nodeType !== Node.ELEMENT_NODE) { node.remove(); return; }

                const tag = node.tagName.toLowerCase();
                if (!allowedTags.has(tag)){
                    // unwrap node but keep children
                    const parent = node.parentNode;
                    while (node.firstChild) parent.insertBefore(node.firstChild, node);
                    parent.removeChild(node);
                    return;
                }

                // remove disallowed attributes
                for (let i = node.attributes.length - 1; i >= 0; i--){
                    const attr = node.attributes[i];
                    const name = attr.name.toLowerCase();
                    if (!((allowedAttrs[tag] || []).includes(name))){
                        node.removeAttribute(attr.name);
                    } else {
                        // check safe hrefs
                        if (tag === 'a' && name === 'href' && !isSafeUrl(attr.value)){
                            node.removeAttribute('href');
                        }
                    }
                }

                // recurse children
                Array.from(node.childNodes).forEach(child => clean(child));
            }

            Array.from(template.content.childNodes).forEach(child => clean(child));
            return template.innerHTML;
        }

        // Añadido: guardar historial en sessionStorage (evita ReferenceError)
        function saveToHistory(role, content){
            try {
                const history = JSON.parse(sessionStorage.getItem('conversation_history') || '[]');
                history.push({ role, content });
                sessionStorage.setItem('conversation_history', JSON.stringify(history));
            } catch (e) {
                console.warn('No se pudo guardar el historial en sessionStorage:', e);
            }
        }
        
        function appendMessage(sender, text) {
            const messageContainer = document.createElement("div");
            messageContainer.classList.add("message-container");
            const messageDiv = document.createElement("div");

            if (sender === 'user') {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = text;
                saveToHistory('user', text);
            } else if (sender === 'bot') {
                messageDiv.classList.add('bot-message');
                // render allowed HTML tags (sanitized) so <strong> se vea como negrita
                const safeHtml = sanitizeHTML(text);
                messageDiv.innerHTML = safeHtml;
                saveToHistory('bot', safeHtml);
            } else { // error or other
                messageDiv.classList.add('error-message');
                messageDiv.textContent = text;
            }

            messageContainer.appendChild(messageDiv);
            // Insert before typing indicator if present
            if (typingIndicator && typingIndicator.parentElement === chatLog) {
                chatLog.insertBefore(messageContainer, typingIndicator);
            } else {
                chatLog.appendChild(messageContainer);
            }
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function showTyping(show = true){
            if (!typingIndicator) return;
            if (show){
                typingIndicator.classList.add('active');
                typingIndicator.setAttribute('aria-hidden','false');
                chatLog.scrollTop = chatLog.scrollHeight;
            } else {
                typingIndicator.classList.remove('active');
                typingIndicator.setAttribute('aria-hidden','true');
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            appendMessage("user", message);
            userInput.value = "";
            userInput.focus();

            showTyping(true);

            try {
                const response = await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message })
                });

                showTyping(false);

                if (!response.ok) {
                    appendMessage("error", `Error del servidor: ${response.statusText}`);
                    return;
                }

                const data = await response.json();
                if (data.response) {
                    appendMessage("bot", data.response);
                } else if (data.error) {
                    appendMessage("error", `Error del bot: ${data.error}`);
                } else {
                    appendMessage("error", "Respuesta inesperada del servidor.");
                }

            } catch (error) {
                showTyping(false);
                appendMessage("error", `Error de conexión: ${error.message}`);
            }
        }

        async function resetChat() {
            try {
                const response = await fetch("/api/reset_chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" }
                });

                if (response.ok) {
                    sessionStorage.removeItem('conversation_history');
                    chatLog.innerHTML = '<div class="message-container"><div class="bot-message">Chat reiniciado. Envia un mensaje para empezar!</div></div>';
                    // recreate typing indicator
                    const typingDiv = document.createElement('div');
                    typingDiv.id = 'typing-indicator';
                    typingDiv.className = 'bot-message typing';
                    typingDiv.innerHTML = '<span></span><span></span><span></span>';
                    chatLog.appendChild(typingDiv);
                    typingIndicator = typingDiv;
                } else {
                    const errorData = await response.json();
                    appendMessage("error", `Error al reiniciar el chat: ${errorData.error || 'Error desconocido'}`);
                }
            } catch (err){
                appendMessage("error", `Error al reiniciar: ${err.message}`);
            }
        }

        async function regenerateResponse() {
            const conversationHistory = JSON.parse(sessionStorage.getItem('conversation_history') || '[]');
            // Find last bot entry and previous user
            let lastBotIndex = -1;
            for (let i = conversationHistory.length - 1; i >= 0; i--){
                if (conversationHistory[i].role === 'bot'){ lastBotIndex = i; break; }
            }
            if (lastBotIndex > 0){
                const lastUser = conversationHistory[lastBotIndex - 1];
                if (!lastUser || lastUser.role !== 'user'){
                    appendMessage("error", "No se encontró un mensaje de usuario previo para regenerar.");
                    return;
                }
                const lastUserMessage = lastUser.content;
                showTyping(true);
                try {
                    const response = await fetch("/api/regenerate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: lastUserMessage })
                    });
                    showTyping(false);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.response) {
                            // remove last bot message from history and DOM
                            // remove last bot message element in DOM
                            const botEls = Array.from(chatLog.querySelectorAll('.bot-message')).filter(el => !el.classList.contains('typing'));
                            if (botEls.length) {
                                const lastBotEl = botEls[botEls.length -1];
                                const parent = lastBotEl.parentElement;
                                if (parent) parent.remove();
                            }
                            // update history
                            conversationHistory.splice(lastBotIndex, 1);
                            conversationHistory.push({ role: 'bot', content: data.response });
                            sessionStorage.setItem('conversation_history', JSON.stringify(conversationHistory));
                            appendMessage("bot", data.response);
                        } else if (data.error) {
                            appendMessage("error", `Error al regenerar: ${data.error}`);
                        } else {
                            appendMessage("error", "Respuesta inesperada al regenerar.");
                        }
                    } else {
                        appendMessage("error", `Error del servidor al regenerar: ${response.statusText}`);
                    }
                } catch (error) {
                    showTyping(false);
                    appendMessage("error", `Error de conexión al regenerar: ${error.message}`);
                }
            } else {
                appendMessage("error", "No hay respuesta del bot para regenerar.");
            }
        }

        userInput.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });

        window.addEventListener('load', () => {
            userInput.focus();
            const storedHistory = JSON.parse(sessionStorage.getItem('conversation_history') || '[]');
            // Restore messages
            storedHistory.forEach(msg => {
                appendMessage(msg.role, msg.content);
            });
            // Ensure typing indicator exists and reference is up-to-date
            if (!document.getElementById('typing-indicator')) {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'bot-message typing';
                typingDiv.innerHTML = '<span></span><span></span><span></span>';
                chatLog.appendChild(typingDiv);
                typingIndicator = typingDiv;
            } else {
                typingIndicator = document.getElementById('typing-indicator');
            }
        });
    </script>
</body>
</html>
